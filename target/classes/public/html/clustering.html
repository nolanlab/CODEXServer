<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clustering</title>
    <link rel="shortcut icon" href="/images/codexlogo.ico" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style4.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


</head>
<body>
    <div class="wrapper">
        <nav id="sidebar" class="active">
            <div class="sidebar-header">
                <h3>Codex pipeline</h3>
                <strong>Codex</strong>
            </div>

            <ul class="list-unstyled components">
                <li>
                    <a href="/html/home.html">
                        <i class="glyphicon glyphicon-home"></i>
                        Home
                    </a>

                    <a href="/html/uploader.html">
                        <i class="glyphicon glyphicon-level-up"></i>
                        Uploader
                    </a>

                    <a href="/html/segm.html">
                        <i class="glyphicon glyphicon-th"></i>
                        Segmentation
                    </a>

                    <a href="/html/gate.html">
                        <i class="glyphicon glyphicon-filter"></i>
                        Gating
                    </a>
                </li>

                <li class="active">
                    <a href="/html/clustering.html">
                        <i class="glyphicon glyphicon-equalizer"></i>
                        Clustering
                    </a>
                </li>

                <li>
                    <a href="#">
                        <i class="glyphicon glyphicon-play-circle"></i>
                        Viewer
                    </a>
                </li>
            </ul>
        </nav>

        <div id="content">

            <nav class="navbar navbar-default">
                <div class="container-fluid">

                    <div class="navbar-header">
                        <button type="button" id="sidebarCollapse" class="btn btn-info navbar-btn" style="background-color: #337ab7">
                            <i class="glyphicon glyphicon-align-left"></i>
                            <span>Menu</span>
                        </button>
                    </div>

                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="/html/faq.html">FAQ</a> </li>
                            <li><a href="/html/contact.html">Contact</a></li>
                            <li><a href="/html/about.html">About us</a></li>
                        </ul>
                    </div>
                </div>
            </nav>

            <h2>Clustering</h2>
            <p>Choose the experiment folder for a user and specify the parameters given below to proceed with segmentation. Make sure that the
                experiment was processed and uploaded to the server before starting.
            </p>

            <div class="container-fluid" style="width:600px;">
                <div class="panel panel-primary">
                    <div class="panel-heading"><i>Clustering configuration parameters</i></div>
                    <div class="panel-body">
                        <form id ="cluster" method="POST" action="http://localhost:4567/runClustering">

                            <div class="form-group">
                                <label for="user">Select User</label>
                                <select name="user" id="user" class="form-control input" placeholder="Choose user" required>
                                    <option value="">Choose user</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="exp">Enter experiment name</label>
                                <select name="exp" id="exp" class="form-control input" placeholder="Choose experiment" required>
                                    <option value="">Choose experiment</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="tstamp">Segmentation file</label>
                                <select name="tstamp" id="tstamp" class="form-control input" placeholder="Choose segmentation file" required>
                                    <option value="">Choose segmentation file</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="fcs">FCS file type</label>
                                <select name="fcs" id="fcs" class="form-control input" placeholder="Choose FCS file type" required>
                                    <option value="compensated">Compensated</option>
                                    <option value="uncompensated">Uncompensated</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="gate">Parent gate</label>
                                <select name="gate" id="gate" class="form-control input" placeholder="Choose parent gate" required>
                                    <option value="ungated">Ungated</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="user">Choose clustering columns</label>
                                <select name="clustcols" id="clustcols" class="form-control input" placeholder="Choose clustering columns" required multiple>
                                    <option value="">Choose clustering columns</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="limitevents">Limit events per file</label>
                                <input type="number" class="form-control" ng-model="limitevents" value="-1" min="-1" id="limitevents" placeholder="Enter limit events per file" name="limitevents" required>
                            </div>

                            <div class="form-group">
                                <label for="transformation">Transformation</label>
                                <select name="transformation" id="transformation" class="form-control input" placeholder="Choose Transformation" required>
                                    <option value="none">None</option>
                                    <option value="asinh">Asinh</option>
                                    <option value="double_asinh">Double Asinh</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="scaling">Scaling factor</label>
                                <input type="number" class="form-control" ng-model="scaling" value="5" min="1" id="scaling" placeholder="Enter Scaling factor" name="scaling" required>
                            </div>

                            <div class="form-group">
                                <label for="noise">Noise threshold</label>
                                <input type="number" class="form-control" ng-model="noise" value="1" step="0.1" min="0" id="noise" placeholder="Enter noise threshold" name="noise" required>
                            </div>

                            <div class="form-group">
                                <label for="rescale">Rescale</label>
                                <select name="rescale" id="rescale" class="form-control input" placeholder="Choose Rescale" required>
                                    <option value="none">None</option>
                                    <option value="sd">Standard deviation</option>
                                    <option value="quantile">Quantile</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="quantile">Quantile</label>
                                <input type="number" class="form-control" ng-model="quantile" value="1" min="0" step="0.05" id="quantile" placeholder="Enter quantile" name="quantile" required>
                            </div>

                            <div class="form-group">
                                <label for="rescaleSeparately">Rescale</label>
                                <select name="rescaleSeparately" id="rescaleSeparately" class="form-control input" placeholder="Choose Rescale separately" required>
                                    <option value="true">True</option>
                                    <option value="false">False</option>
                                </select>
                            </div>

                            <div class="form-group" >
                                <input type="submit" id="submit" value="Start clustering" class="btn btn-primary btn-lg" data-loading-text="Running clustering" />
                            </div>

                            <div class="progress">
                                <div id = "pro" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                                    <font color="black"> 0% segmented </font>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    $('#cluster').submit(function() {
        var $this = $('#submit');
        $this.button('loading');
        setTimeout(function() {
            $this.button('reset');
        }, 20000);
    });
</script>

<script type="text/javascript">
    $(document).ready(function () {
        $('#sidebarCollapse').on('click', function () {
            $('#sidebar').toggleClass('active');
        });
    });
</script>

<script type="text/javascript">
    function showProgress() {
        setInterval(function(){
            jQuery.ajax({
                type: "GET",
                url: "/getProgress",
                success: function(result) {
                    $('#pro').css("width", result + '%');
                    $('#pro').html(result + "% segmented");
                },
            });
        }, 5000);
    }
</script>

<script type="text/javascript" language="javascript">
    var userParam;
    var expParam;
    var tstampParam;
    var fcsParam;
    var clusterParam;
    $().ready(function() {
        $.ajax({
            type: "GET",
            url: "/getUserList",
            contentType: "application/json",
            dataType: "json",
            success: function(msg) {
                $("#user").get(0).options.length = 0;
                $("#user").get(0).options[0] = new Option("Choose user", "-1");
                $.each(msg, function(i,obj)
                {
                    var div_data="<option value="+obj+">"+obj+"</option>";
                    $(div_data).appendTo('#user');
                });
                $("#user").bind("change", function() {
                    GetExperiments($(this).val());
                });
            },
            error: function() {
                alert("Failed to load users");
            }
        });
    });

    function GetExperiments(user) {
        if(user != -1) {
            userParam = user;
            $("#exp").get(0).options.length = 0;
            $("#tstamp").get(0).options.length = 0;
            $("#clustcols").get(0).options.length = 0;

            $.ajax({
                type: "GET",
                url: "/getExperimentList?user="+user,
                contentType: "application/json",
                dataType: "json",
                success: function(msg) {
                    $("#exp").get(0).options.length = 0;
                    $("#exp").get(0).options[0] = new Option("Choose experiment", "-1");
                    $("#tstamp").get(0).options.length = 0;
                    $("#tstamp").get(0).options[0] = new Option("Choose segmentation configuration", "-1");
                    $("#clustcols").get(0).options.length = 0;
                    $("#clustcols").get(0).options[0] = new Option("Choose clustering columns", "-1");
                    $.each(msg, function(i,obj)
                    {
                        var div_data="<option value="+obj+">"+obj+"</option>";
                        $(div_data).appendTo('#exp');
                    });

                    $("#exp").bind("change", function() {
                        GetSegTimestamps($("#user").val(), $("#exp").val());
                    });
                }
            });
        }
        else {
            $("#exp").get(0).options.length = 0;
            $("#exp").get(0).options[0] = new Option("Choose experiment", "-1");
            $("#tstamp").get(0).options.length = 0;
            $("#tstamp").get(0).options[0] = new Option("Choose segmentation configuration", "-1");
            $("#clustcols").get(0).options.length = 0;
            $("#clustcols").get(0).options[0] = new Option("Choose X", "-1");
        }
    }

    function GetSegTimestamps(user, exp) {
        if(user != -1 && exp != -1) {
            expParam = exp;
            $("#tstamp").get(0).options.length = 0;
            $.ajax({
                type: "GET",
                url: "/getSegTimestampsForGate?user="+user+"&exp="+exp,
                contentType: "application/json",
                dataType: "json",
                success: function(msg) {
                    $("#tstamp").get(0).options.length = 0;
                    $("#tstamp").get(0).options[0] = new Option("Choose segmentation configuration", "-1");
                    $.each(msg, function(i,obj)
                    {
                        var div_data="<option value="+obj+">"+obj+"</option>";
                        $(div_data).appendTo('#tstamp');
                    });

                    $("#tstamp").bind("change", function() {
                        GetClusterCols($("#user").val(), $("#exp").val(), $("#tstamp").val());
                    });
                }
            });
        }
        else {
            $("#tstamp").get(0).options.length = 0;
            $("#tstamp").get(0).options[0] = new Option("Choose segmentation configuration", "-1");
            $("#clustcols").get(0).options.length = 0;
            $("#clustcols").get(0).options[0] = new Option("Choose clustering columns", "-1");
        }
    }


    function GetClusterCols(user, exp, tstamp) {
        if(user != -1 && exp != -1 && tstamp != -1) {
            tstampParam = tstamp;
            $('#clustcols').get(0).options.length = 0;
            $.ajax({
                type: "GET",
                url: "/getClusterCols?user="+user+"&exp="+exp+"&tstamp="+tstamp,
                contentType: "application/json",
                dataType: "json",
                success: function(msg) {
                    $('#clustcols').get(0).options.length = 0;
                    $('#clustcols').get(0).options[0] = new Option("Choose X", "-1");
                    $.each(msg, function(i,obj)
                    {
                        var div_data="<option value="+obj+">"+obj+"</option>";
                        $(div_data).appendTo('#clustcols');
                    });

                }
            });
        }
        else {
            $("#clustcols").get(0).options.length = 0;
            $("#clustcols").get(0).options[0] = new Option("Choose X", "-1");
        }
    }
</script>

</html>