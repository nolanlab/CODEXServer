<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gating</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/imgareaselect-default.css" />
    <script type="text/javascript" src="/scripts/jquery.min.js"></script>
    <script type="text/javascript" src="/scripts/jquery.imgareaselect.pack.js"></script>
</head>
<body>
<div class="container">
    <h2 align="center">Gating</h2><br />
    <div class="col-sm-5">
        <div id="gatingconfig">
            <div class="panel panel-default">
                <div class="panel-heading">Specify FCS config</div>
                <div class="panel-body">
                    <div class="form-group">
                        <label for="user">User</label>
                        <select name="user" id="user" class="form-control input" placeholder="Choose user" required>
                            <option value="">Choose user</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="exp">Experiment name</label>
                        <select name="exp" id="exp" class="form-control input" placeholder="Choose experiment" required>
                            <option value="">Choose experiment</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tstamp">Segmentation configuration</label>
                        <select name="tstamp" id="tstamp" class="form-control input" placeholder="Choose segmentation configuration" required>
                            <option value="">Choose segmentation configuration</option>
                        </select>
                    </div>


                    <div class="form-group">
                        <label for="fcs">FCS file type</label>
                        <select name="fcs" id="fcs" class="form-control input" placeholder="Choose FCS file type" required>
                            <option value="compensated">Compensated</option>
                            <option value="uncompensated">Uncompensated</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-5">
        <div id="imagecontainer" style="display: none;" >
            <div class="panel panel-default">
                <div class="panel-heading">
                    Gating image
                    <button class="pull-right btn btn-primary btn-xs" id="addButton" style="display:none">Add</button>
                </div>
                <div class="panel-body">

                    <div class="form-group">
                        <label for="x">X</label>
                        <select name="x" id="x" class="form-control input" placeholder="Choose X" required>
                            <option value="">Choose X</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="y">Y</label>
                        <select name="y" id="y" class="form-control input" placeholder="Choose Y" required>
                            <option value="">Choose Y</option>
                        </select>
                    </div>

                    <div class="form-group" id="imgForGate" style="display: none;">
                        <img src="/images/cinqueterre.jpg" class="img-rounded" alt="Cinque Terre" width="304" height="236" id="photo">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" language="javascript">
    var userParam;
    var expParam;
    var tstampParam;
    var fcsParam;
    var xParam;
    var yParam;
        $().ready(function() {
            $.ajax({
                type: "GET",
                url: "/getUserList",
                contentType: "application/json",
                dataType: "json",
                success: function(msg) {
                    $("#user").get(0).options.length = 0;
                    $("#user").get(0).options[0] = new Option("Choose user", "-1");
                    $.each(msg, function(i,obj)
                    {
                        var div_data="<option value="+obj+">"+obj+"</option>";
                        $(div_data).appendTo('#user');
                    });
                    $("#user").bind("change", function() {
                        GetExperiments($(this).val());
                    });
                },
                error: function() {
                    alert("Failed to load users");
                }
            });
        });

        function GetExperiments(user) {
            if(user != -1) {
                userParam = user;
                $("#exp").get(0).options.length = 0;
                $("#tstamp").get(0).options.length = 0;
                $("#x").get(0).options.length = 0;
                $("#y").get(0).options.length = 0;

                $.ajax({
                    type: "GET",
                    url: "/getExperimentList?user="+user,
                    contentType: "application/json",
                    dataType: "json",
                    success: function(msg) {
                        $("#exp").get(0).options.length = 0;
                        $("#exp").get(0).options[0] = new Option("Choose experiment", "-1");
                        $("#tstamp").get(0).options.length = 0;
                        $("#tstamp").get(0).options[0] = new Option("Choose segmentation configuration", "-1");
                        $("#x").get(0).options.length = 0;
                        $("#x").get(0).options[0] = new Option("Choose X", "-1");
                        $("#y").get(0).options.length = 0;
                        $("#y").get(0).options[0] = new Option("Choose Y", "-1");
                        $("#imagecontainer").css('display', 'none');
                        $.each(msg, function(i,obj)
                        {
                            var div_data="<option value="+obj+">"+obj+"</option>";
                            $(div_data).appendTo('#exp');
                        });

                        $("#exp").bind("change", function() {
                            GetSegTimestamps($("#user").val(), $("#exp").val());
                        });
                    }
                });
            }
            else {
                $("#exp").get(0).options.length = 0;
                $("#exp").get(0).options[0] = new Option("Choose experiment", "-1");
                $("#tstamp").get(0).options.length = 0;
                $("#tstamp").get(0).options[0] = new Option("Choose segmentation configuration", "-1");
                $("#x").get(0).options.length = 0;
                $("#x").get(0).options[0] = new Option("Choose X", "-1");
                $("#y").get(0).options.length = 0;
                $("#y").get(0).options[0] = new Option("Choose Y", "-1");
                $("#imagecontainer").css('display', 'none');
            }
        }

        function GetSegTimestamps(user, exp) {
            if(user != -1 && exp != -1) {
                expParam = exp;
                $("#tstamp").get(0).options.length = 0;
                $.ajax({
                    type: "GET",
                    url: "/getSegTimestampsForGate?user="+user+"&exp="+exp,
                    contentType: "application/json",
                    dataType: "json",
                    success: function(msg) {
                        $("#tstamp").get(0).options.length = 0;
                        $("#tstamp").get(0).options[0] = new Option("Choose segmentation configuration", "-1");
                        $.each(msg, function(i,obj)
                        {
                            var div_data="<option value="+obj+">"+obj+"</option>";
                            $(div_data).appendTo('#tstamp');
                        });

                        $("#tstamp").bind("change", function() {
                            GetXYList($("#user").val(), $("#exp").val(), $("#tstamp").val());
                        });
                    }
                });
            }
            else {
                $("#tstamp").get(0).options.length = 0;
                $("#tstamp").get(0).options[0] = new Option("Choose segmentation configuration", "-1");
                $("#x").get(0).options.length = 0;
                $("#x").get(0).options[0] = new Option("Choose X", "-1");
                $("#y").get(0).options.length = 0;
                $("#y").get(0).options[0] = new Option("Choose Y", "-1");
                $("#imagecontainer").css('display', 'none');
            }
        }


        function GetXYList(user, exp, tstamp) {
            if(user != -1 && exp != -1 && tstamp != -1) {
                tstampParam = tstamp;
                $('#x').get(0).options.length = 0;
                $('#y').get(0).options.length = 0;
                $.ajax({
                    type: "GET",
                    url: "/getXYListForGate?user="+user+"&exp="+exp+"&tstamp="+tstamp,
                    contentType: "application/json",
                    dataType: "json",
                    success: function(msg) {
                        $("#imagecontainer").show();
                        $('#x').get(0).options.length = 0;
                        $('#x').get(0).options[0] = new Option("Choose X", "-1");
                        $('#y').get(0).options.length = 0;
                        $('#y').get(0).options[0] = new Option("Choose Y", "-1");
                        $.each(msg, function(i,obj)
                        {
                            var div_data="<option value="+obj+">"+obj+"</option>";
                            $(div_data).appendTo('#x');
                            $(div_data).appendTo('#y');
                        });

                        $("#fcs").bind("change", function() {
                            GetImage($("#user").val(), $("#exp").val(), $("#tstamp").val(), $("#fcs").val(), $("#x").val(), $("#y").val());
                        });

                        $("#x").bind("change", function() {
                            GetImage($("#user").val(), $("#exp").val(), $("#tstamp").val(), $("#fcs").val(), $("#x").val(), $("#y").val());
                        });

                        $("#y").bind("change", function() {
                            GetImage($("#user").val(), $("#exp").val(), $("#tstamp").val(), $("#fcs").val(), $("#x").val(), $("#y").val());
                        });
                    }
                });
            }
            else {
                $("#x").get(0).options.length = 0;
                $("#x").get(0).options[0] = new Option("Choose X", "-1");
                $("#y").get(0).options.length = 0;
                $("#y").get(0).options[0] = new Option("Choose Y", "-1");
                $("#imagecontainer").css('display', 'none');
            }
        }

        function GetImage(user, exp, tstamp, fcs, x, y) {
            if(user != -1 && exp != -1 && tstamp != -1 && x != -1 && y != -1) {
                xParam = x;
                yParam = y;
                fcsParam = fcs;
                $.ajax({
                    type: "GET",
                    url: "/getImage?user="+user+"&exp="+exp+"&tstamp="+tstamp+"&FCS="+fcs+"&X="+x+"&Y="+y,
                    contentType: "application/json",
                    dataType: "json",
                    success: function(msg) {
                        <!--$("#addButton").show();-->
                        $("#imgForGate").show();
                    }
                });
            }
            else {
                <!--$("#addButton").css('display', 'none');-->
                $("#imgForGate").css('display', 'none');
            }
        }
    </script>

<script type="text/javascript">
    $('img#photo').imgAreaSelect({
    onSelectEnd: function (img, selection) {
        var xList = [
            selection.x1, selection.x2, selection.x2,selection.x1
        ];
        var yList = [
            selection.y1, selection.y1,selection.y2, selection.y2
        ];
        var coordinatesList = [
            {
                x : xList,
                y: yList
            }
        ];

        $.ajax({
            type: "GET",
            url: "/setGate?user="+userParam+"&exp="+expParam+"&tstamp="+tstampParam+"&fcs="+fcsParam+"&x="+xParam+"&y="+yParam+"&coordinates="+JSON.stringify(coordinatesList),
            contentType: "application/json",
            dataType: "json",
            success: function(msg) {
            },
            error: function() {
                alert("Failed to load users");
            }
        });
        }
    });
</script>

<!--<script type="text/javascript">-->
    <!--$("#addButton").click(function () {-->
        <!--var count = function(i, val) { return val*1+1 } ;-->
        <!--var inputHtml = $('<div class="panel panel-default">' +-->
            <!--'<div class="panel-heading">' +-->
                <!--'Gating image' +-->
                <!--'<button class="pull-right btn btn-primary btn-xs" id="addButton" style="display:none">Add</button>' +-->
                <!--'</div>' +-->
            <!--'<div class="panel-body">' +-->
                <!--'<div class="form-group">' +-->
                    <!--'<label for="x' + count+1 + '">X</label>' +-->
                    <!--'<select name="x' + count+1 + '" id="x' + count+1 + '" class="form-control input" placeholder="Choose X" required>' +-->
                    <!--'<option value="">Choose X</option>' +-->
                    <!--'</select>' +-->
                <!--'</div>' +-->
                <!--'<div class="form-group">' +-->
                    <!--'<label for="y' + count+1 + '">Y</label>' +-->
                    <!--'<select name="y' + count+1 + '" id="y' + count+1 + '" class="form-control input" placeholder="Choose Y" required>' +-->
                    <!--'<option value="">Choose Y</option>' +-->
                    <!--'</select>' +-->
                <!--'</div>' +-->
                <!--'<div class="form-group" id="imgForGate" style="display: none;">' +-->
                    <!--'<img src="/images/cinqueterre.jpg" class="img-rounded" alt="Cinque Terre" width="304" height="236" id="photo">' +-->
                <!--'</div>' +-->
            <!--'</div>' +-->
        <!--'</div>');-->
        <!--$("#imagecontainer").append(inputHtml);-->
        <!--GetXYList($("#user").val(), $("#exp").val(), $("#tstamp").val(), count);-->
    <!--});-->
<!--</script>-->
</html>